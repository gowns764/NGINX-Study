# 고성능 부하분산

## 1 소개
- 부하가 지속적으로 증가할 수록 동일한 시스템을 추가 투입하는 아키텍처 기술을 **수평적인 확장**이라 부른다.
- 부하를 분산하는 과정에서는 사용자 경험을 해치지 않아야 한다.
- 엔진엑스가 사용자에게 제공하는 애플리케이션 동작에는 문제가 없어야 한다.

## 2 HTTP 부하분산
- 엔진엑스의 upstream 블록과 http 모듈을 이용해 HTTP 서버 간에 부하를 분산한다.
- ```
  upstream backend {
      server 10.10.12.45:80     weight=1;
      server app.example.com:80 weight=2;
      server spare.example.com:80 backup;
  }
  server {
      location / {
          proxy_pass http://backend;
      }
  }
  ```
- 이 엔진엑스 설정은 80 포트를 사용하는 HTTP 서버 두 대로 부하를 분산한다.
    - 설정한 프라이머리 서버 두 대에 문제가 발생해 연결이 불가능하면 backup 서버로 지정한 서버를 사용한다.
    - 지정한 weight 매갸변수 값에 따라 두 번째 서버는 첫 번째 서버보다 두 배 많은 요청을 받는다.
    - weight의 기본값은 1이며 생략할 수 있다.
- HTTP upstream 모듈을 이용해 HTTP 프로토콜 요청에 대한 부하분산 방식을 정의한다.
    - 부하분산을 위한 목적지 풀은 유닉스 소켓, IP 주소, DNS 레코드 혹은 이들의 조합으로 구성한다.
    - 또한, 개별 요청에 대해 어떤 업스트림 서버를 할당할지 매개변수로 정의한다.
- 각 업스트림 대상은 server 지시자로 설정한다.
    - server 지시자는 유닉스 소켓, IP 주소, FQDN 형식으로 표시된 도메인 정보 등을 몇 가지 추가 매개변수와 함께 지정한다.
    - 매개변수는 요청을 적절한 목적지로 전달하도록 추가 제어 방법을 제공한다.
    - 이러한 매개변수는 분산 알고리즘에 가중치를 적용하거나 서버가 어떤 상태인지 알려주며, 서버 가용 여부를 판단하는 방법 등을 포함한다.

## 3 TCP 부하분산
- 엔진엑스의 upstream 블록과 stream 모듈을 이용해 TCP 서버 간에 부하를 분산한다.
- ```
  stream {
    upstream mysql_read {
        server read1.example.com:3306     weight=5;
        server read2.example.com:3306
        server 10.10.12.34:3306           backup;
    }
    server {
        listen 3306;
        proxy_pass mysql_read;
    }
  }
  ```
- 이 엔진엑스 설정의 server 블록은 3306 포트로 TCP 요청을 받아읽기 전용 복제본 두 대로 구성된 MySQL 서버로 부하를 분산한다.
  - 만약, 프라이머리로 지정한 MySQL 서버 두 대 모두가 다운되면 backup 매개변수로 지정한 서버로 요청을 전달한다.
- 엔진엑스 설치 전후 설정을 바꾸지 않았다면 엔진엑스의 기본 설정 파일 경로인 conf.d 폴더는 http 블록에 포함된다.
  - 따라서, stream 모듈을 이용한 이 설정은 stream.conf.d라는 별도의 폴더를 생성해 저장하는 것이 좋다.
  - 경로를 nginx.conf 파일의 stream 블록에 추가해 엔진엑스가 참조하도록 한다.
    - /etc/nginx/nginx.conf 설정 파일 :
    - ```
      user nginx;
      worker_process auto;
      pid /run/nginx.pid

      stream {
          include /etc/nginx/stream.conf.d/*.conf;
      }
      ```
    - /etc/nginx/stream.conf.d/mysql_read.conf 설정 파일 :
    - ```
      upstream mysql_read {
          server read1.example.com:3306     weight=5;
          server read2.example.com:3306;
          server 10.10.12.34:3306           backup;
      }
      server {
          listen 3306;
          proxy_pass mysql_read;
      }
      ```
- http와 stream 모듈의 가장 큰 차이점은 OSI 모델의 서로 다른 계층에서 동작한다는 점이다.
    - http 컨텍스트는 7계층, stream 컨텍스트는 4계층에서 동작한다.
    - http 모듈이 HTTP 프로토콜을 완전히 이해하도록 특별히 설계된 반면, stream 모듈은 패킷의 전달 경로 결정과 부하분산에 더 중점을 둔다.
    - 엔진엑스에서 TCP 부하분산은 stream 모듈을 이용해 정의한다.
    - http 모듈과 마찬가지로 stream 모듈도 업스트림 서버 풀을 만들거나 수신할 개별 서버를 지정한다.
    - 서버가 특정 포트로 요청을 받게 하려면 수신할 포트를 설정에 추가하거나 IP 주소와 함께 포트 번호를 기술한다.
    - 정의한 서버가 다른 서버로 요청을 전달하는 리버스 프록시 서버인지 혹은 일반적인 업스트림 풀에 포함된 서버인지에 관계없이 목적지 서버 목록에 정의한다.
- stream 모듈을 이용하는 경우 옵션을 통해 TCP 연결과 관계된 리버스 프록시의 여러 속성을 변경할 수 있다.
    - 유효한 SSL/TLS 인증서 제한, 타임아웃, 킵얼라이브 시간 설정 등이 있다.
    - 일부 옵션은 엔진엑스 변수를 값으로 사용할 수 있는데, 다운로드 속도 제한이나 SSL/TLS 인증서 유효성 검사에서 사용할 이름이 지정된 변수 혹은 이 변수가 포함된 값을 옵션에 사용할 수 있다.
- TCP 부하분산을 위한 업스트림 블록은 HTTP의 업스트림 블록과 매우 유사하다.
    - 목적지를 정의하는 데 유닉스 소켓, IP 주소, FQDN을 사용하며 가중치, 최대 동시 연결 수, DNS 리졸버, 연결 증가 주기, 서버의 상태 매개변수 등을 사용한다.

## 4 UDP 부하분산
- udp로 정의된 upstream 블록을 엔진엑스의 stream 모듈에서 사용해 UDP 서버 간에 부하를 분산한다.
- ```
  stream {
      upstream ntp {
          server ntp1.example.com:123   weight=2;
          server ntp2.example.com:123;
      }

      server {
          listen 123udp;
          proxy_pass ntp;
      }
  }
  ```
- 예제의 설정은 UDP 프로토콜을 사용해 NTP 서버 두 대로 부하를 전달한다.
    - UDP 프로토콜의 부하분산 설정은 listen 지시자에 udp 매개변수만 추가하면 된다.
- 부하분산이 적용된 서비스에서 클라이언트와 서버가 패킷을 여러 번 주고받아야 한다면 reuseport 매개변수를 사용한다.
    - 부하분산이 적용된 서비스는 오픈VPN, VoIP, 가상 데스크톱 환경, DTLS 등이 있다.
    - 다음 예제는 엔진엑스를 통해 OpenVPN으로 패킷을 전달해주는 설정이다.
    - ```
      stream {
          server {
              listen 1195 udp reuseport;
              proxy_pass 127.0.0.1:1194;
          }
      }
      ```
- UDP 부하분산의 TCP 부하분산에 대한 가장 큰 차이점은 listen 지시자를 통해 UDP 데이터그램을 처리할 소켓을 지정한다는 점이다.
    - 데이터그램을 다룰 때는 TCP 부하분산에서 사용하지 않는 지시자를 몇 가지 사용한다.
    - 대표적으로 엔진엑스가 업스트림 서버로부터 수신할 것으로 예상되는 응답의 크기를 지정하는 데 procy_response 지시자를 사용한다.
        - 이 지시자를 사용하지 않으면 proxy_timeout 지시자의 제한값이 되기 전까지 무제한으로 응답을 처리한다.
        - proxy_timeout은 연결을 닫기 전에 목적지 서버로의 읽기, 쓰기 작업 완료를 기다리는 시간을 지정하는 데 사용한다.
- reuseport 매개변수는 엔진엑스가 워커 프로세스별로 개별 수신 소켓을 만들어 사용하도록 한다.
    - 커널은 엔진엑스로 보내야 하는 연결들을 워커 프로세스 단위로 분산하고, 클라이언트와 서버가 주고받는 여러 패킷을 동시에 처리할 수 있다.

## 5 부하분산 알고리즘